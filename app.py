import streamlit as st
from openai import OpenAI
from pypdf import PdfReader
import docx

# ---------- Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø¹Ø§Ù…Ø© ----------
st.set_page_config(
    page_title="Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ù„Ù‘Ù…Ù†ÙŠ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©",
    page_icon="ğŸ“š",
    layout="wide",
)

st.title("ğŸ“š Ù…Ø³Ø§Ø¹Ø¯ Ø¹Ù„Ù‘Ù…Ù†ÙŠ Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©")
st.write(
    "Ø§Ø±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© (PDF Ø£Ùˆ DOCX)ØŒ Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆÙ…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…ØŒ "
    "Ø«Ù… Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± **ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØªÙ‚Ø±ÙŠØ±** Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ."
)

# ---------- Ø¯Ø§Ù„Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© PDF ----------
def read_pdf(uploaded_file) -> str:
    reader = PdfReader(uploaded_file)
    text = ""
    for i, page in enumerate(reader.pages, start=1):
        try:
            page_text = page.extract_text() or ""
        except Exception:
            page_text = ""
        text += f"\n\n----- ØµÙØ­Ø© {i} -----\n\n{page_text}"
    return text.strip()

# ---------- Ø¯Ø§Ù„Ø© Ù„Ù‚Ø±Ø§Ø¡Ø© DOCX ----------
def read_docx(uploaded_file) -> str:
    document = docx.Document(uploaded_file)
    paragraphs = [p.text for p in document.paragraphs if p.text.strip()]
    return "\n".join(paragraphs).strip()

# ---------- ØªÙ‚Ø³ÙŠÙ… Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ----------
col_left, col_right = st.columns([1.1, 0.9])

with col_left:
    st.subheader("ğŸ“„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙˆØ±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©")

    program_name = st.text_input("Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ", "Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ù…ÙˆØ¬Ù‘ÙÙ‡ â€“ Ø¹Ù„Ù‘Ù…Ù†ÙŠ")
    target_audience = st.text_input("Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©", "Ù…ÙˆØ¬Ù‘Ù‡Ùˆ Ø§Ù„Ù…ÙˆØ§Ø¯ â€“ Ù…Ø¹Ù„Ù…ÙˆÙ† â€“ Ù‚ÙŠØ§Ø¯Ø§Øª ØªØ±Ø¨ÙˆÙŠØ©")
    duration = st.text_input("Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬", "ÙŠÙˆÙ…Ø§Ù† â€“ Ù¡Ù¢ Ø³Ø§Ø¹Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ©")
    main_theme = st.text_input("Ø§Ù„Ù…Ø¬Ø§Ù„ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³", "Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„ØªØ±Ø¨ÙˆÙŠ Ø§Ù„Ø­Ø¯ÙŠØ« â€“ Ø§Ù„ØªØºØ°ÙŠØ© Ø§Ù„Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¡Ø©")

    short_desc = st.text_area(
        "ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)",
        "Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙŠÙ‡Ø¯Ù Ø¥Ù„Ù‰ ØªØ·ÙˆÙŠØ± Ù…Ù‡Ø§Ø±Ø§Øª Ø§Ù„Ù…ÙˆØ¬Ù‘Ù‡ÙŠÙ† Ø§Ù„ØªØ±Ø¨ÙˆÙŠÙŠÙ† ÙÙŠ Ø§Ù„Ø¥Ø´Ø±Ø§Ù Ø§Ù„Ø­Ø¯ÙŠØ« ÙˆØªØ­Ø³ÙŠÙ† ØªØ¹Ù„Ù… Ø§Ù„Ø·Ù„Ø§Ø¨.",
        height=90,
    )

    st.markdown("### ğŸ“ Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©")
    uploaded_file = st.file_uploader(
        "Ø§Ø®ØªØ± Ù…Ù„Ù Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© (PDF Ø£Ùˆ DOCX)",
        type=["pdf", "docx"],
        help="Ù…Ù„Ù PDF Ù†ØµÙŠ Ø£Ùˆ DOCX. Ù„Ùˆ PDF Ø¹Ø¨Ø§Ø±Ø© Ø¹Ù† ØµÙˆØ± ÙÙ‚Ø·ØŒ ÙŠÙ„Ø²Ù… ØªØ­ÙˆÙŠÙ„Ù‡ Ù„Ù†Øµ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… OCR Ø£ÙˆÙ„Ø§Ù‹.",
    )

    extracted_text = st.text_area(
        "Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© (ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ„)",
        value="",
        height=200,
        help="Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ø­Ù‚Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ØŒ ÙˆÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„ÙŠÙ‡ Ù„Ùˆ Ø£Ø­Ø¨Ø¨Øª.",
    )

    if uploaded_file is not None and st.button("ğŸ“¥ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù†Øµ / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ"):
        try:
            if uploaded_file.name.lower().endswith(".pdf"):
                text = read_pdf(uploaded_file)
            else:
                text = read_docx(uploaded_file)

            if not text:
                st.warning("Ù„Ù… ÙŠØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø£ÙŠ Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù. ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ù„Ù ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù†Øµ ÙˆÙ„ÙŠØ³ ØµÙˆØ± ÙÙ‚Ø·.")
            else:
                # ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
                st.session_state["extracted_text"] = text
                extracted_text = text
                st.success(f"ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø¨Ù†Ø¬Ø§Ø­. Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø±ÙˆÙ: {len(text):,}")
        except Exception as e:
            st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ù†Øµ: {e}")

    # Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Øµ Ù…Ù† session_state Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯
    if "extracted_text" in st.session_state and not extracted_text:
        extracted_text = st.session_state["extracted_text"]

with col_right:
    st.subheader("ğŸ“ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…")

    default_criteria = """Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„Ø£Ù‡Ø¯Ø§Ù
- ÙˆØ¬ÙˆØ¯ Ù‡Ø¯Ù Ø¹Ø§Ù… ÙˆØ§Ø¶Ø­ ÙŠØ¹Ø¨Ø± Ø¹Ù…Ø§ ÙŠØ³Ø¹Ù‰ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø¥Ù„Ù‰ ØªØ­Ù‚ÙŠÙ‚Ù‡ ÙˆÙŠØ±ØªØ¨Ø· Ø¨Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†.
- ØªÙˆØ§ÙØ± Ù†ÙˆØ§ØªØ¬ ØªØ¹Ù„Ù… Ù…ØµØ§ØºØ© Ø¨Ø´ÙƒÙ„ Ø¬ÙŠØ¯ (ÙˆØ§Ø¶Ø­Ø©ØŒ Ù…Ø­Ø¯Ø¯Ø©ØŒ Ø³Ù„ÙˆÙƒÙŠØ©ØŒ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ù‚ÙŠØ§Ø³ØŒ ÙˆØ§Ù‚Ø¹ÙŠØ©).
- ØªÙ†ÙˆØ¹ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ø¨ÙŠÙ† Ø§Ù„Ù…Ø¹Ø±ÙÙŠ ÙˆØ§Ù„Ù…Ù‡Ø§Ø±ÙŠ ÙˆØ§Ù„ÙˆØ¬Ø¯Ø§Ù†ÙŠ.
- Ù…Ù„Ø§Ø¡Ù…Ø© Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ù„Ù„Ø²Ù…Ù† Ø§Ù„Ù…ØªØ§Ø­ ÙˆØªØªØ§Ø¨Ø¹Ù‡Ø§ ÙÙŠ ØªØ³Ù„Ø³Ù„ Ù…Ù†Ø·Ù‚ÙŠ.

Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø«Ø§Ù†ÙŠ: Ø§Ù„Ù…Ø­ØªÙˆÙ‰
- Ø§Ø±ØªØ¨Ø§Ø· Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ù‡Ø¯Ù Ø§Ù„Ø¹Ø§Ù… ÙˆÙ†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù….
- Ù…Ù„Ø§Ø¡Ù…Ø© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù„Ø§Ø­ØªÙŠØ§Ø¬Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙˆØ®Ø¨Ø±Ø§ØªÙ‡Ù… Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©.
- Ø®Ù„Ùˆ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù† Ø§Ù„ØªÙ…ÙŠÙŠØ² Ø¨Ø£ÙŠ Ø´ÙƒÙ„.
- ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø­ØªÙˆÙ‰ (ØªØ¯Ø±Ø¬ Ù…Ù† Ø§Ù„Ø³Ù‡Ù„ Ø¥Ù„Ù‰ Ø§Ù„ØµØ¹Ø¨ØŒ Ù…Ù† Ø§Ù„Ù…Ø¹Ù„ÙˆÙ… Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù‡ÙˆÙ„ØŒ Ø¹Ø¯Ù… Ø§Ù„ØªÙƒØ±Ø§Ø±ØŒ Ø­Ø¯Ø§Ø«Ø© Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹Ø§Øª).

Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø«Ø§Ù„Ø«: Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©
- Ø§Ø±ØªØ¨Ø§Ø· Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø¨Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆÙ†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… Ù…Ù† Ø­ÙŠØ« Ø§Ù„ÙƒÙ… ÙˆØ§Ù„ÙƒÙŠÙ ÙˆØ§Ù„ØªØ³Ù„Ø³Ù„.
- Ù…Ø±Ø§Ø¹Ø§Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ† ÙˆØ¨ÙŠØ¦Ø© Ø¹Ù…Ù„Ù‡Ù… ÙˆØ§Ù‡ØªÙ…Ø§Ù…Ø§ØªÙ‡Ù….
- ÙˆØ¬ÙˆØ¯ Ø£Ù†Ø´Ø·Ø© Ø§Ø³ØªÙ‡Ù„Ø§Ù„ÙŠØ© (ØªØ¹Ø§Ø±ÙØŒ ØªÙˆÙ‚Ø¹Ø§ØªØŒ Ù‚ÙˆØ§Ø¹Ø¯ØŒ ØªÙˆØ¶ÙŠØ­ Ø§Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ¯ÙˆØ± Ø§Ù„Ù…ØªØ¯Ø±Ø¨).
- ØªÙˆØ§ÙØ± Ø®ØµØ§Ø¦Øµ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø¬ÙŠØ¯ (Ø¹Ù†ÙˆØ§Ù† ÙˆØ§Ø¶Ø­ØŒ Ø²Ù…Ù† Ù…Ø­Ø¯Ø¯ØŒ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ù…Ù†Ø¸Ù…Ø©ØŒ Ù…ÙˆØ§Ø¯ ÙˆØ£Ø¯ÙˆØ§ØªØŒ Ù…Ø´Ø§Ø±ÙƒØ© Ø¥ÙŠØ¬Ø§Ø¨ÙŠØ©ØŒ Ø¥Ø«Ø§Ø±Ø© Ø§Ù„ØªÙÙƒÙŠØ±).
- ØªÙ†ÙˆØ¹ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ (Ù…Ø­Ø§Ø¶Ø±Ø© Ù‚ØµÙŠØ±Ø©ØŒ Ù…Ù†Ø§Ù‚Ø´Ø©ØŒ Ø¹ØµÙ Ø°Ù‡Ù†ÙŠØŒ Ø¹Ù…Ù„ ØªØ¹Ø§ÙˆÙ†ÙŠØŒ Ù„Ø¹Ø¨ Ø£Ø¯ÙˆØ§Ø±ØŒ Ù…Ø­Ø§ÙƒØ§Ø©ØŒ Ø­Ù„ Ù…Ø´ÙƒÙ„Ø§ØªØŒ Ø§ÙƒØªØ´Ø§Ù...).
- ØªÙ†ÙˆØ¹ Ø§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© ÙˆÙ…Ù„Ø§Ø¡Ù…ØªÙ‡Ø§ Ù„Ù„Ø£Ù‡Ø¯Ø§Ù ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†.

Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø±Ø§Ø¨Ø¹: Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©
- ØªÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø§Ø¯Ø© (Ø¯Ù„ÙŠÙ„ Ù…Ø¯Ø±Ø¨ØŒ Ø¯Ù„ÙŠÙ„ Ù…ØªØ¯Ø±Ø¨ØŒ Ù…Ø§Ø¯Ø© Ù…Ø±Ø¬Ø¹ÙŠØ©ØŒ Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ØŒ Ø¹Ø±ÙˆØ¶ ØªÙ‚Ø¯ÙŠÙ…ÙŠØ©ØŒ Ø£Ø¯ÙˆØ§Øª ØªÙ‚ÙŠÙŠÙ…).
- ÙˆØ¶ÙˆØ­ Ø§Ù„Ù„ØºØ© ÙˆØ³Ù‡ÙˆÙ„ØªÙ‡Ø§ ÙˆØ®Ù„ÙˆÙ‡Ø§ Ù…Ù† Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø¥Ù…Ù„Ø§Ø¦ÙŠØ© ÙˆØ§Ù„Ù†Ø­ÙˆÙŠØ© ÙˆØ§Ù„Ù…Ø·Ø¨Ø¹ÙŠØ©.
- ÙˆØ¬ÙˆØ¯ ØªÙˆØ«ÙŠÙ‚ Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆÙ‚Ø§Ø¦Ù…Ø© Ù…Ø±Ø§Ø¬Ø¹ ÙˆÙ…ØµØ§Ø¯Ø± Ø¥Ø¶Ø§ÙÙŠØ©.
- Ø¬ÙˆØ¯Ø© Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬ (ØºÙ„Ø§Ù Ø¬Ø°Ø§Ø¨ØŒ Ù…Ù‚Ø¯Ù…Ø©ØŒ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø­ØªÙˆÙŠØ§ØªØŒ Ø£Ø¬Ù†Ø¯Ø© Ø¹Ù…Ù„ØŒ ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø®Ø·ÙˆØ· ÙˆØ§Ù„Ù…Ø³Ø§ÙØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø£Ø´ÙƒØ§Ù„ ÙˆØ±Ø³ÙˆÙ… ØªÙˆØ¶ÙŠØ­ÙŠØ©ØŒ ØªÙˆÙØ± Ù†Ø³Ø® ÙˆØ±Ù‚ÙŠØ© ÙˆØ¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠØ©ØŒ Ù‚Ø§Ø¦Ù…Ø© Ù…ØµØ·Ù„Ø­Ø§Øª).

Ø§Ù„Ù…Ø¬Ø§Ù„ Ø§Ù„Ø®Ø§Ù…Ø³: Ø§Ù„ØªÙ‚ÙˆÙŠÙ…
- ÙˆØ¬ÙˆØ¯ Ù…Ø±Ø§Ø­Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ… (Ù‚Ø¨Ù„ÙŠØŒ Ø¨Ù†Ø§Ø¦ÙŠØŒ Ù†Ù‡Ø§Ø¦ÙŠ).
- ØªÙ†ÙˆØ¹ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¨Ù…Ø§ ÙŠÙ†Ø§Ø³Ø¨ Ù†ÙˆØ§ØªØ¬ Ø§Ù„ØªØ¹Ù„Ù… (Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ù…Ø¹Ø±ÙÙŠØ©ØŒ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ø§Ø±ÙŠØ©ØŒ Ø§Ø³ØªØ¨ÙŠØ§Ù†Ø§Øª ÙˆØ¬Ø¯Ø§Ù†ÙŠØ©ØŒ ØªÙ‚ÙˆÙŠÙ… Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†).
- ØªÙˆØ¶ÙŠØ­ Ø£Ø³Ø§Ù„ÙŠØ¨ Ø¥Ø­ØµØ§Ø¦ÙŠØ© Ù…Ù‚ØªØ±Ø­Ø© Ù„Ø­Ø³Ø§Ø¨ ÙØ§Ø¹Ù„ÙŠØ© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ (Ù…Ø«Ù„ Ù†Ø³Ø¨Ø© Ø§Ù„ÙƒØ³Ø¨ Ø§Ù„Ù…Ø¹Ø¯Ù‘Ù„Ø©ØŒ Ù…Ø±Ø¨Ø¹ Ø¥ÙŠØªØ§) Ù…Ø¹ Ø£Ù…Ø«Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ÙŠØ© Ù…Ø¨Ø³Ø·Ø©.
"""

    criteria = st.text_area(
        "Ù†Øµ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…",
        value=default_criteria,
        height=330,
        help="ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø£Ùˆ Ø§Ø³ØªØ¨Ø¯Ø§Ù„Ù‡Ø§ Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„ØªÙŠ Ù„Ø¯ÙŠÙƒ.",
    )

# ---------- Ø¯Ø§Ù„Ø© Ù„Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª ----------
def build_prompt(
    program_name: str,
    target_audience: str,
    duration: str,
    main_theme: str,
    short_desc: str,
    content: str,
    criteria: str,
) -> str:
    intro_desc = f"ÙˆØµÙ Ù…Ø®ØªØµØ± Ø¹Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬:\n{short_desc}\n\n" if short_desc.strip() else ""

    prompt = f"""
Ø£Ù†Øª Ø®Ø¨ÙŠØ± Ø¹Ø±Ø¨ÙŠ ÙÙŠ ØªØµÙ…ÙŠÙ… ÙˆÙ…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø­Ù‚Ø§Ø¦Ø¨ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©ØŒ ÙˆØªØ¹Ù…Ù„ Ø§Ù„Ø¢Ù† ÙƒÙ…Ø±Ø§Ø¬Ø¹ Ø¬ÙˆØ¯Ø© Ù„Ø­Ù‚ÙŠØ¨Ø© ØªØ¯Ø±ÙŠØ¨ÙŠØ© ØªØ§Ø¨Ø¹Ø© Ù„Ù…Ø¤Ø³Ø³Ø© "Ø¹Ù„Ù‘Ù…Ù†ÙŠ".

Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù…Ù†Ùƒ Ø£Ù† ØªÙ‚ÙŠÙ‘Ù… Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø¨Ø¯Ù‚Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø© Ø£Ø¯Ù†Ø§Ù‡ØŒ Ø«Ù… ØªØ®Ø±Ø¬ Ø¨ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ ÙŠØªØ¶Ù…Ù†:
- Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ© ÙÙŠ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©.
- Ø§Ù„ÙØ¬ÙˆØ§Øª ÙˆØ§Ù„Ø«ØºØ±Ø§Øª.
- Ù…Ù‚ØªØ±Ø­Ø§Øª Ø¹Ù…Ù„ÙŠØ© Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù‡Ø¯Ø§ÙØŒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŒ Ø§Ù„Ø£Ù†Ø´Ø·Ø©ØŒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©ØŒ ÙˆØ§Ù„ØªÙ‚ÙˆÙŠÙ….

Ø£ÙˆÙ„Ù‹Ø§: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù† Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠ (Ù„Ù„ÙÙ‡Ù… Ø§Ù„Ø³ÙŠØ§Ù‚ÙŠ):
- Ø§Ø³Ù… Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {program_name}
- Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©: {target_audience}
- Ù…Ø¯Ø© Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬: {duration}
- Ø§Ù„Ù…Ø¬Ø§Ù„ / Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ø±Ø¦ÙŠØ³: {main_theme}

{intro_desc}Ø«Ø§Ù†ÙŠÙ‹Ø§: Ù†Øµ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© (Ø§Ù„Ø£Ù‡Ø¯Ø§ÙØŒ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŒ Ø§Ù„Ø£Ù†Ø´Ø·Ø©ØŒ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©ØŒ Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªÙ‚ÙŠÙŠÙ…...). Ø±ÙƒÙ‘Ø² ÙÙŠ ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¹Ù„Ù‰ Ù…Ø¯Ù‰ ØªÙˆØ§ÙØ± Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ± ÙˆÙ„ÙŠØ³ Ø¹Ù„Ù‰ Ø¥Ø¹Ø§Ø¯Ø© ÙƒØªØ§Ø¨Ø© Ø§Ù„Ù†Øµ:

\"\"\" 
{content}
\"\"\" 

Ø«Ø§Ù„Ø«Ù‹Ø§: Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø§Ù„Ø§Ù„ØªØ²Ø§Ù… Ø¨Ù‡Ø§ (Ø§Ù„Ù…Ø¬Ø§Ù„Ø§ØªØŒ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±ØŒ Ø§Ù„Ù…Ø¤Ø´Ø±Ø§Øª):

\"\"\" 
{criteria}
\"\"\" 

Ø±Ø§Ø¨Ø¹Ù‹Ø§: Ø·Ø±ÙŠÙ‚Ø© Ø¹Ù…Ù„Ùƒ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:

1) Ù‚Ø¯Ù‘Ù… Ø£ÙˆÙ„Ù‹Ø§ Ù…Ù„Ø®ØµÙ‹Ø§ ØªÙ†ÙÙŠØ°ÙŠÙ‹Ø§ ÙÙŠ ÙÙ‚Ø±ØªÙŠÙ† Ø¥Ù„Ù‰ Ø«Ù„Ø§Ø« ÙÙ‚Ø±Ø§Øª ÙŠÙˆØ¶Ø­:
   - Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø¬ÙˆØ¯Ø© Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©.
   - Ø£Ù‡Ù… Ù†Ù‚Ø§Ø· Ø§Ù„Ù‚ÙˆØ©.
   - Ø£Ù‡Ù… Ø§Ù„ÙØ¬ÙˆØ§Øª.

2) Ø¨Ø¹Ø¯ Ø°Ù„ÙƒØŒ Ù‚ÙŠÙ‘Ù… Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© ÙˆÙÙ‚ Ø§Ù„Ù…Ø¬Ø§Ù„Ø§Øª Ø§Ù„Ø®Ù…Ø³Ø© (Ø§Ù„Ø£Ù‡Ø¯Ø§Ù â€“ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ â€“ Ø§Ù„Ø£Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ø£Ø³Ø§Ù„ÙŠØ¨ ÙˆØ§Ù„ÙˆØ³Ø§Ø¦Ù„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© â€“ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ© â€“ Ø§Ù„ØªÙ‚ÙˆÙŠÙ…)ØŒ ÙƒÙ…Ø§ Ù‡ÙŠ Ù…Ø°ÙƒÙˆØ±Ø© ÙÙŠ Ø§Ù„Ù…Ø¹Ø§ÙŠÙŠØ±ØŒ Ù…Ø¹ ØªÙ†Ø¸ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ± ÙƒØ§Ù„ØªØ§Ù„ÙŠ ÙÙŠ ÙƒÙ„ Ù…Ø¹ÙŠØ§Ø±:
   - Ø¯Ø±Ø¬Ø© Ù…Ù† 0 Ø¥Ù„Ù‰ 3 (0 = ØºÙŠØ± Ù…ØªØ­Ù‚Ù‚ØŒ 1 = Ø¶Ø¹ÙŠÙØŒ 2 = Ù…ØªÙˆØ³Ø·ØŒ 3 = Ù…ØªØ­Ù‚Ù‚ Ø¨Ø¯Ø±Ø¬Ø© Ø¹Ø§Ù„ÙŠØ©).
   - ØªÙØ³ÙŠØ± Ø³Ø¨Ø¨ Ø§Ù„Ø¯Ø±Ø¬Ø© ÙÙŠ 2â€“4 Ø£Ø³Ø·Ø± Ù…Ø¹ Ø§Ù„Ø¥Ø´Ø§Ø±Ø© Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø¥Ù† Ø£Ù…ÙƒÙ†.
   - Ø§Ù‚ØªØ±Ø§Ø­ ØªØ¹Ø¯ÙŠÙ„ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ø¶Ø­Ø© Ù„ØªØ­Ø³ÙŠÙ† Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹ÙŠØ§Ø±.

3) ÙÙŠ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ØªÙ‚Ø±ÙŠØ±ØŒ Ù‚Ø¯Ù‘Ù…:
   - Ù‚Ø§Ø¦Ù…Ø© Ù…Ø±ØªÙ‘Ø¨Ø© Ø¨Ø£Ù‡Ù… 5 Ø£ÙˆÙ„ÙˆÙŠØ§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© (Ù…Ù† Ø§Ù„Ø£Ù‡Ù… Ø¥Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ø£Ù‡Ù…ÙŠØ©).
   - Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ© Ù„Ø£Ù†Ø´Ø·Ø© Ø£Ùˆ Ø£Ø³Ø§Ù„ÙŠØ¨ ØªØ¯Ø±ÙŠØ¨ÙŠØ© Ø£Ùˆ Ø£Ø¯ÙˆØ§Øª ØªÙ‚ÙŠÙŠÙ… ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡Ø§ Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„ØªÙ‚ÙˆÙŠØ© Ø§Ù„Ø­Ù‚ÙŠØ¨Ø©.

Ø§ÙƒØªØ¨ ØªÙ‚Ø±ÙŠØ±Ùƒ ÙƒÙ„Ù‡ Ø¨Ø§Ù„Ù„ØºØ© Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø§Ù„ÙØµØ­Ù‰ Ø§Ù„Ø¨Ø³ÙŠØ·Ø©ØŒ ÙˆØ¨Ø£Ø³Ù„ÙˆØ¨ Ø¨Ù†Ù‘Ø§Ø¡ ÙŠØ±ÙƒÙ‘Ø² Ø¹Ù„Ù‰ Ø§Ù„Ø­Ù„ÙˆÙ„ ÙˆØ§Ù„ØªØ­Ø³ÙŠÙ†Ø§Øª ÙˆÙ„ÙŠØ³ Ø§Ù„Ù†Ù‚Ø¯ ÙÙ‚Ø·.
    """.strip()

    return prompt

# ---------- Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù†Ù…ÙˆØ°Ø¬ OpenAI ----------
def call_openai(prompt: str) -> str:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": "You are an expert Arabic educational program and training package reviewer. Answer only in high-quality Arabic.",
            },
            {"role": "user", "content": prompt},
        ],
    )
    return response.choices[0].message.content.strip()

# ---------- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù†Ø§ØªØ¬ ----------
st.markdown("---")
st.subheader("ğŸ§  ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª / ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ…")

col_a, col_b = st.columns([0.4, 0.6])

with col_a:
    generate_prompt_btn = st.button("ğŸ“ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª (Ø¨Ø¯ÙˆÙ† Ø§ØªØµØ§Ù„ Ø¨Ù€ OpenAI)")
with col_b:
    generate_report_btn = st.button("ğŸ¤– ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø¹Ø¨Ø± OpenAI")

output = st.empty()

if generate_prompt_btn:
    if not extracted_text.strip():
        st.warning("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø£ÙˆÙ„Ù‹Ø§.")
    else:
        prompt = build_prompt(
            program_name,
            target_audience,
            duration,
            main_theme,
            short_desc,
            extracted_text,
            criteria,
        )
        output.markdown("#### Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª Ø§Ù„Ù…ÙˆÙ„Ù‘ÙØ¯")
        st.code(prompt, language="markdown")

if generate_report_btn:
    if not extracted_text.strip():
        st.warning("Ù…Ù† ÙØ¶Ù„Ùƒ Ø§Ø±ÙØ¹ Ø§Ù„Ø­Ù‚ÙŠØ¨Ø© Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Øµ Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬ Ø£ÙˆÙ„Ù‹Ø§.")
    else:
        prompt = build_prompt(
            program_name,
            target_audience,
            duration,
            main_theme,
            short_desc,
            extracted_text,
            criteria,
        )
        with st.spinner("Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ù…Ù† Ù†Ù…ÙˆØ°Ø¬ OpenAI..."):
            try:
                report = call_openai(prompt)
                output.markdown("#### ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ù†Ø§ØªØ¬")
                st.write(report)
            except Exception as e:
                st.error(f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù€ OpenAI: {e}")
