import streamlit as st
from openai import OpenAI
from pypdf import PdfReader
import docx
import json

# ==============================
#       ูุนุงููุฑ ุซุงุจุชุฉ ูุฎููุฉ
# ==============================
FIXED_CRITERIA = """
ุงููุฌุงู ุงูุฃูู: ุงูุฃูุฏุงู
- ูุฌูุฏ ูุฏู ุนุงู ูุงุถุญ ูุนุจุฑ ุนูุง ูุณุนู ุงูุจุฑูุงูุฌ ุฅูู ุชุญูููู ููุฑุชุจุท ุจุงุญุชูุงุฌุงุช ุงููุชุฏุฑุจูู.
- ุชูุงูุฑ ููุงุชุฌ ุชุนูู ูุตุงุบุฉ ุจุดูู ุฌูุฏ (ูุงุถุญุฉุ ูุญุฏุฏุฉุ ุณููููุฉุ ูุงุจูุฉ ููููุงุณุ ูุงูุนูุฉ).
- ุชููุน ููุงุชุฌ ุงูุชุนูู ุจูู ุงูุฌูุงูุจ ุงููุนุฑููุฉ ูุงูููุงุฑูุฉ ูุงููุฌุฏุงููุฉ.
- ููุงุกูุฉ ููุงุชุฌ ุงูุชุนูู ููุฒูู ุงููุชุงุญ ูุชุชุงุจุนูุง ูู ุชุณูุณู ููุทูู.

ุงููุฌุงู ุงูุซุงูู: ุงููุญุชูู
- ุงุฑุชุจุงุท ููุถูุนุงุช ุงููุญุชูู ุจุงููุฏู ุงูุนุงู ูููุงุชุฌ ุงูุชุนูู.
- ููุงุกูุฉ ุงููุญุชูู ูุงุญุชูุงุฌุงุช ุงููุชุฏุฑุจูู ูุฎุจุฑุงุชูู ุงูุณุงุจูุฉ ูุจูุฆุฉ ุนูููู.
- ุฎูู ุงููุญุชูู ูู ุฃู ุชูููุฒ (ุฏููุ ุฌูุณุ ุฎูููุฉ ุงุฌุชูุงุนูุฉ...).
- ุชูุธูู ุงููุญุชูู: ุชุฏุฑุฌ ูู ุงูุณูู ุฅูู ุงูุตุนุจุ ููู ุงููุนููู ุฅูู ุงููุฌูููุ ูุนุฏู ุงูุชูุฑุงุฑุ ูุชุฌูุจ ุงูุญุดู.
- ุญุฏุงุซุฉ ุงููุญุชูู ูููุงูุจุชู ูููุณุชุฌุฏุงุช ุงูุนูููุฉ ูุงูุชูููููุฌูุฉ.

ุงููุฌุงู ุงูุซุงูุซ: ุงูุฃูุดุทุฉ ูุงูุฃุณุงููุจ ูุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ
- ุงุฑุชุจุงุท ุงูุฃูุดุทุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฃูุฏุงู ูููุงุชุฌ ุงูุชุนูู ูู ุญูุซ ุงููู ูุงูููู ูุงูุชุณูุณู.
- ูุฑุงุนุงุฉ ุงูุฃูุดุทุฉ ููุณุชูู ุงููุชุฏุฑุจูู ูุงูุชูุงูุงุชูู ูุจูุฆุฉ ุนูููู.
- ูุฌูุฏ ุฃูุดุทุฉ ุงุณุชููุงููุฉ (ุชุนุงุฑูุ ุชููุนุงุชุ ููุงุนุฏุ ุชูุถูุญ ุฃูุฏุงู ุงูุจุฑูุงูุฌ ูุฏูุฑ ุงููุชุฏุฑุจ).
- ุชูุงูุฑ ุฎุตุงุฆุต ุงููุดุงุท ุงูุฌูุฏ (ุนููุงู ูุงุถุญุ ุฒูู ูุญุฏุฏุ ุฎุทูุงุช ููุธูุฉุ ููุงุฏ ูุฃุฏูุงุชุ ูุดุงุฑูุฉ ุฅูุฌุงุจูุฉุ ุฅุซุงุฑุฉ ุงูุชูููุฑุ ูุงุจููุฉ ุงูุชุทุจูู ูู ุงููุงูุน).
- ุชููุน ุฃุณุงููุจ ุงูุชุฏุฑูุจ (ูุญุงุถุฑุฉ ูุตูุฑุฉุ ููุงูุดุฉุ ุนุตู ุฐูููุ ุนูู ูุฑุฏูุ ุนูู ุชุนุงูููุ ูุนุจ ุฃุฏูุงุฑุ ูุญุงูุงุฉุ ุญู ูุดููุงุชุ ุงูุชุดุงู...).
- ุชููุน ุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ (ุนุฑูุถ ุชูุฏูููุฉุ ููุฏูููุงุชุ ููุญุงุชุ ููุงุฐุฌุ ุตูุฑุ ููุงุฏ ุฑูููุฉ...) ูููุงุกูุชูุง ููุฃูุฏุงู ูุงููุญุชูู ูุงููุชุฏุฑุจูู.

ุงููุฌุงู ุงูุฑุงุจุน: ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ
- ูุฌูุฏ ุฏููู ูุฏุฑุจ ูุชุถูู: ููุฏูุฉุ ููุฑุณุ ุฅุฑุดุงุฏุงุช ูููุฏุฑุจุ ุงูุฅุทุงุฑ ุงูุนุงู ููุจุฑูุงูุฌุ ุฃุฌูุฏุฉ ุนููุ ุฃูุดุทุฉ ุชุฏุฑูุจูุฉุ ููุงุญุธุงุชุ ูุฑุงุฌุน.
- ูุฌูุฏ ุฏููู ูุชุฏุฑุจ ูุชุถูู: ููุฏูุฉุ ููุฑุณุ ุงูุฅุทุงุฑ ุงูุนุงูุ ุฃุฌูุฏุฉ ุนููุ ุฃูุดุทุฉุ ูุณุงุญุงุช ููุชุฏููู.
- ูุฌูุฏ ูุงุฏุฉ ูุฑุฌุนูุฉ ุชุบุทู ููุถูุน ุงูุชุฏุฑูุจุ ููุณูุฉ ุฅูู ูุญุฏุงุช ูุงุถุญุฉ ุจุฃูุฏุงู ูุญุฏุฏุฉ.
- ูุฌูุฏ ุฃูุฑุงู ุนูู ูุนุฑูุถ ุชูุฏูููุฉ ูุฃุฏูุงุช ุชูููู ูุฑุชุจุทุฉ ุจุฃูุดุทุฉ ุงูุชุฏุฑูุจ.
- ูุถูุญ ุงููุบุฉ ูุจุณุงุทุชูุงุ ูุฎูููุง ูู ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ูุงููุญููุฉ ูุงููุทุจุนูุฉุ ูุงุณุชุฎุฏุงู ุนูุงูุงุช ุชุฑููู ููุงุณุจุฉ.
- ูุฌูุฏ ุชูุซูู ูููุญุชูู ููุงุฆูุฉ ูุฑุงุฌุน ููุตุงุฏุฑ ุฅุถุงููุฉ.
- ุฌูุฏุฉ ุงูุฅุฎุฑุงุฌ ูุงูุชุตููู (ุบูุงู ุฌุฐุงุจุ ููุฏูุฉุ ูุงุฆูุฉ ูุญุชููุงุชุ ุฃุฌูุฏุฉ ุนููุ ุชูุณูู ุงูุฎุทูุท ูุงููุณุงูุงุชุ ุงุณุชุฎุฏุงู ุฃุดูุงู ูุฑุณูู ุชูุถูุญูุฉุ ุชููุฑ ูุณุฎ ูุฑููุฉ ูุฅููุชุฑูููุฉุ ูุงุฆูุฉ ูุตุทูุญุงุช ููููุงููู ุงูุฑุฆูุณุฉ).

ุงููุฌุงู ุงูุฎุงูุณ: ุงูุชูููู
- ูุฌูุฏ ุชูููู ูุจูู ูููุงุณ ูุณุชูู ุงููุชุฏุฑุจูู ูุจู ุจุฏุงูุฉ ุงูุชุฏุฑูุจ.
- ูุฌูุฏ ุชูููู ุจูุงุฆู ุฃุซูุงุก ุงูุชูููุฐ ูููุงุณ ุงูุชูุฏู ูุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงููุณุชูุฑุฉ.
- ูุฌูุฏ ุชูููู ููุงุฆู ูููุงุณ ุชุญููู ููุงุชุฌ ุงูุชุนูู ูู ููุงูุฉ ุงูุจุฑูุงูุฌ.
- ุชููุน ุฃุฏูุงุช ุงูุชูููู (ุงุฎุชุจุงุฑุงุช ูุนุฑููุฉุ ุจุทุงูุงุช ููุงุญุธุฉ ููุงุฑูุฉุ ุงุณุชุจูุงูุงุช ูุฌุฏุงููุฉุ ุชูููู ููุชุฌุงุช ุงููุชุฏุฑุจูู ูุซู: ุฏุฑุณุ ูุณููุฉุ ุฎุทุฉุ ุชูุฑูุฑ...).
- ุงูุฅุดุงุฑุฉ ุฅูู ุฃุณุงููุจ ููุงุณุจุฉ ูุญุณุงุจ ูุงุนููุฉ ุงูุจุฑูุงูุฌ ุงูุชุฏุฑูุจู (ูุซู ูุณุจุฉ ุงููุณุจ ุงููุนุฏููุฉุ ูุฑุจุน ุฅูุชุง) ูุน ุฅููุงููุฉ ุชูุฏูู ุฃูุซูุฉ ูุจุณุทุฉ ููุงุณุชุฎุฏุงู.
"""

# ==============================
#       ุฅุนุฏุงุฏ ุงูุตูุญุฉ + CSS
# ==============================
st.set_page_config(
    page_title="ุงูุงุณุชุดุงุฑู ุงูุฐูู ููุฑูู ุงูุชุตููู ุงูุชุนูููู",
    page_icon="๐",
    layout="wide",
    initial_sidebar_state="expanded",
)

CUSTOM_CSS = """
<style>
html, body, [class*="css"] {
    font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
}

/* ุญุงููุฉ ุงููุญุชูู */
.main .block-container {
    padding-top: 1.2rem;
    padding-bottom: 2.2rem;
    padding-left: 2.5rem;
    padding-right: 2.5rem;
    background: #f3f4f6;
    border-radius: 24px;
}

/* ุชุฑููุณุฉ */
.header-card {
    background: linear-gradient(135deg, #1d4ed8, #1e40af);
    color: #f9fafb;
    padding: 1.4rem 1.8rem;
    border-radius: 18px;
    box-shadow: 0 16px 34px rgba(15, 23, 42, 0.35);
    margin-bottom: 1.2rem;
}
.header-title {
    font-size: 1.7rem;
    font-weight: 800;
    margin-bottom: 0.25rem;
}
.header-subtitle {
    font-size: 0.96rem;
    opacity: 0.95;
}

/* ูุฑุช ุฑุฆูุณู */
.card {
    background: #ffffff;
    border-radius: 18px;
    padding: 1.2rem 1.3rem;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.07);
    border: 1px solid rgba(148, 163, 184, 0.25);
}

/* ุนูููุฉ ุตุบูุฑุฉ */
.section-label {
    font-size: 0.78rem;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #6b7280;
    margin-bottom: 0.05rem;
}

/* ูุต ูุณุงุนุฏุฉ */
.help-text {
    font-size: 0.78rem;
    color: #6b7280;
}

/* Textarea */
textarea, .stTextArea textarea {
    border-radius: 12px !important;
}

/* ุณุงูุฏุจุงุฑ */
[data-testid="stSidebar"] {
    background: #0b1120 !important;
}
.sidebar-title {
    font-size: 1.1rem;
    font-weight: 800;
    color: #e5e7eb;
    margin-bottom: 0.3rem;
}
.sidebar-subtitle {
    font-size: 0.85rem;
    color: #9ca3af;
    margin-bottom: 0.9rem;
}
.sidebar-footer {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 1rem;
}

/* ุฃุฒุฑุงุฑ */
.stButton > button {
    border-radius: 999px !important;
    padding: 0.6rem 1.4rem !important;
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    border: none !important;
    cursor: pointer !important;
    transition: 0.2s ease-in-out !important;
}
.primary-btn button {
    background-color: #2563eb !important;
    color: #ffffff !important;
    box-shadow: 0 6px 16px rgba(37, 99, 235, 0.45) !important;
}
.primary-btn button:hover {
    background-color: #1e40af !important;
    transform: translateY(-2px) !important;
}
</style>
"""
st.markdown(CUSTOM_CSS, unsafe_allow_html=True)

with st.sidebar:
    st.markdown('<div class="sidebar-title">ูุคุณุณุฉ ุนููููู ููุชุนููู ูุงูุชุฏุฑูุจ</div>', unsafe_allow_html=True)
    st.markdown(
        '<div class="sidebar-subtitle">'
        'ูุณุงุนุฏ ุฐูู ูุชุญููู ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ ูุฅุตุฏุงุฑ ุชูุฑูุฑ ูููู ููู ุฅุทุงุฑ ุฌูุฏุฉ ุชุฑุจูู ูุนุชูุฏ.'
        '</div>',
        unsafe_allow_html=True,
    )
    st.markdown("---")
    st.markdown(
        '<div class="sidebar-footer">ุงูุฅุตุฏุงุฑ 1.0 โ ููุงุณุชุฎุฏุงู ุงูุชุฌุฑูุจู ุฏุงุฎู ูุฑู ุนููููู ุงูุชุตููููุฉ ูุงูุชุฏุฑูุจูุฉ.</div>',
        unsafe_allow_html=True,
    )

st.markdown(
    """
    <div class="header-card">
        <div class="header-title">๐ ูุณุงุนุฏ ุนููููู ููุฑุงุฌุนุฉ ูุชูููู ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ</div>
        <div class="header-subtitle">
            ุงุฑูุน ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ ุจูุณุฎุชูุง ุงููุงููุฉุ ูุฏูุน ุงููุธุงู ูููู ุจุชุญููู ุฌููุน ุงูุตูุญุงุช ูุฅุตุฏุงุฑ ุชูุฑูุฑ ุชูุตููู
            ููุถุญ ููุงุท ุงูููุฉ ููุฑุต ุงูุชุทููุฑุ ููู ูุนุงููุฑ ุฌูุฏุฉ ุซุงุจุชุฉ ุชุบุทู ูู ุจูุฏ ูู ุงูุฃูุฏุงู ูุงููุญุชูู ูุงูุฃูุดุทุฉ ูุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ ูุงูุชูููู.
        </div>
    </div>
    """,
    unsafe_allow_html=True,
)

# ==============================
#      ุฏูุงู ูุฑุงุกุฉ ุงููููุงุช
# ==============================
def read_pdf(uploaded_file) -> str:
    reader = PdfReader(uploaded_file)
    text = ""
    for i, page in enumerate(reader.pages, start=1):
        try:
            page_text = page.extract_text() or ""
        except Exception:
            page_text = ""
        # ูุถุน ุนูุงูุฉ ูุงุถุญุฉ ููุตูุญุฉ ูููุฏุฑ ุงูููุฏูู ูุฑุฌุน ููุง
        text += f"\n\n----- ุตูุญุฉ {i} -----\n\n{page_text}"
    return text.strip()


def read_docx(uploaded_file) -> str:
    document = docx.Document(uploaded_file)
    paragraphs = [p.text for p in document.paragraphs if p.text.strip()]
    return "\n".join(paragraphs).strip()


if "extracted_text" not in st.session_state:
    st.session_state["extracted_text"] = ""

# ==============================
#      ุงููุงุฑุช ุงูุชูุงุนูู ุงูุฑุฆูุณู
# ==============================
st.markdown('<div class="card">', unsafe_allow_html=True)
st.markdown('<div class="section-label">Upload & Analyze</div>', unsafe_allow_html=True)
st.markdown("### ๐ ุฑูุน ุงูุญููุจุฉ ูุชุญููููุง")

uploaded_file = st.file_uploader(
    "ุงุฎุชุฑ ููู ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ (PDF ุฃู DOCX)",
    type=["pdf", "docx"],
    help="ููููู ุฑูุน ุงูุญููุจุฉ ูุงููุฉ ุญุชู ูู ูุงูุช ุชุญุชูู ุนูู ุนุฏุฏ ูุจูุฑ ูู ุงูุตูุญุงุช.",
)

show_text = st.checkbox("ุนุฑุถ ุงููุต ุงููุณุชุฎุฑุฌ ูู ุงูุญููุจุฉ ูุจู ุงูุชุญููู", value=False)

st.markdown('<div class="primary-btn">', unsafe_allow_html=True)
analyze_btn = st.button("๐ ุชุญููู ุงูุญููุจุฉ ูุฅุตุฏุงุฑ ุชูุฑูุฑ ุชูุงุนูู")
st.markdown("</div>", unsafe_allow_html=True)

if show_text:
    st.markdown("#### ๐ ุงููุต ุงููุณุชุฎุฑุฌ ูู ุงูุญููุจุฉ (ููุงุทูุงุน ุฃู ุงูุชุนุฏูู)")
    st.text_area(
        "",
        key="extracted_text",
        height=220,
        help="ูุฐุง ุงููุต ูู ูุง ูุชู ุชุญูููู ูุฅุตุฏุงุฑ ุงูุชูุฑูุฑ. ูููู ุชุนุฏูู ุจุนุถ ุงูุฃุฌุฒุงุก ุฅู ูุฒู.",
    )

report_container = st.container()

# ==============================
#   ุจูุงุก ุงูุจุฑููุจุช ูุงุณุชุฏุนุงุก ุงูููุฏูู
# ==============================
def build_prompt(content: str) -> str:
    prompt = f"""
ุฃูุช ุฎุจูุฑ ุนุฑุจู ูู ุชุตููู ููุฑุงุฌุนุฉ ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ.

ุฃูุงูู ูุต ุญููุจุฉ ุชุฏุฑูุจูุฉ ูุงููุฉ. ุงููุต ููุณูู ุฅูู ุตูุญุงุช ุจุนูุงูุฉ ูุงุถุญุฉ ุจูุฐุง ุงูุดูู:
"----- ุตูุญุฉ 1 -----", "----- ุตูุญุฉ 2 -----" ... ุฅูุฎ.
ุงูุชุฑุถ ุฃู ูู ุตูุญุฉ ููู ููุฑุฉ ูููุฉุ ููุง ุชุชุฌุงูู ุฃู ุฌุฒุก ูู ุงููุต ุนูุฏูุง.

ูุทููุจ ููู ุชุญููู ุงูุญููุจุฉ ุจุฏูุฉ ููู ูุนุงููุฑ ุฌูุฏุฉ ุซุงุจุชุฉ (ูุฐููุฑุฉ ูุงุญููุง)ุ
ูุน ุงูุญุฑุต ุนูู:
- ุนุฏู ุฅุบูุงู ุฃู ูุฌุงู ูู ูุฌุงูุงุช ุงูุชูููู.
- ุนุฏู ุชุฌุงูู ุฃู ูุนูุงุฑ ุฃู ูุคุดุฑุ ุฅุฐุง ูู ุชุชูุงูุฑ ูุนูููุงุช ูุงููุฉ ููุนูุงุฑ ูุนูููุ ุงุฐูุฑ ุตุฑุงุญุฉ: "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุฐุง ุงููุนูุงุฑ ูู ุงูุญููุจุฉ".
- ูุญุงููุฉ ุงูุฅุดุงุฑุฉ ุฅูู ุฃูุซูุฉ ูู ูุต ุงูุญููุจุฉ ูุน ุฐูุฑ ุฑูู ุงูุตูุญุฉ ุฅู ุฃููู (ูุซุงู: "ุตูุญุฉ 5: ...").

ูุฌุจ ุฃู ุชูุฑุฌูุน ุงููุชูุฌุฉ ูู ุตูุฑุฉ JSON ุตุงูุญ ููุทุ ุจุฏูู ุฃู ูุต ุฎุงุฑุฌ JSONุ ูุจุงูุจููุฉ ุงูุชุงููุฉ (ูุน ุงูุงูุชุฒุงู ุจุฃุณูุงุก ุงูุญููู ููุง ูู):

{{
  "executive_summary": "ููุฎุต ุชูููุฐู ุนุงู ุนู ุฌูุฏุฉ ุงูุญููุจุฉ ูู ููุฑุงุช ููููุฉ.",
  "overall_observations": "ููุงุญุธุงุช ุนุงูุฉ ุนู ุงูุญููุจุฉ ููู.",
  "domains": [
    {{
      "name": "ุงููุฌุงู ุงูุฃูู: ุงูุฃูุฏุงู",
      "score": 0,
      "score_explanation": "ุชูุณูุฑ ููุฌุฒ ูุณุจุจ ุงูุฏุฑุฌุฉ ูู 0 ุฅูู 3.",
      "strengths": ["ููุทุฉ ููุฉ 1", "ููุทุฉ ููุฉ 2"],
      "gaps": ["ูุฌูุฉ/ุซุบุฑุฉ 1", "ูุฌูุฉ/ุซุบุฑุฉ 2"],
      "recommendations": ["ุชูุตูุฉ ุนูููุฉ 1", "ุชูุตูุฉ ุนูููุฉ 2"],
      "examples_of_issues": ["ูุซุงู ููุดููุฉ ูุน ุฐูุฑ ุงูุตูุญุฉ ุฅู ุฃูููุ ูุซู: ุตูุญุฉ 3: ..."]
    }},
    {{
      "name": "ุงููุฌุงู ุงูุซุงูู: ุงููุญุชูู",
      "score": 0,
      "score_explanation": "",
      "strengths": [],
      "gaps": [],
      "recommendations": [],
      "examples_of_issues": []
    }},
    {{
      "name": "ุงููุฌุงู ุงูุซุงูุซ: ุงูุฃูุดุทุฉ ูุงูุฃุณุงููุจ ูุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ",
      "score": 0,
      "score_explanation": "",
      "strengths": [],
      "gaps": [],
      "recommendations": [],
      "examples_of_issues": []
    }},
    {{
      "name": "ุงููุฌุงู ุงูุฑุงุจุน: ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ",
      "score": 0,
      "score_explanation": "",
      "strengths": [],
      "gaps": [],
      "recommendations": [],
      "examples_of_issues": []
    }},
    {{
      "name": "ุงููุฌุงู ุงูุฎุงูุณ: ุงูุชูููู",
      "score": 0,
      "score_explanation": "",
      "strengths": [],
      "gaps": [],
      "recommendations": [],
      "examples_of_issues": []
    }}
  ],
  "top_priorities": ["ุฃูู ุฃููููุฉ 1", "ุฃูู ุฃููููุฉ 2", "ุฃูู ุฃููููุฉ 3"],
  "global_recommendations": ["ุชูุตูุฉ ุนุงูุฉ 1", "ุชูุตูุฉ ุนุงูุฉ 2"]
}}

ูุง ุชุบููุฑ ุฃุณูุงุก ุงูุญููู. ุชุฃูุฏ ุฃู ุงูููู ูููุง ูุตูุต ุนุฑุจูุฉ ุฃู ุฃุนุฏุงุฏ ุตุญูุญุฉ ููุฏุฑุฌุงุช.
ุฅุฐุง ูู ุชุชููุฑ ูุนูููุงุช ูุงููุฉ ููุฌุงู ุฃู ูุนูุงุฑุ ุงุฐูุฑ ุฐูู ุจูุถูุญ ูู ุงูุญููู ุงูููุงุณุจุฉ.

ูุต ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ:

\"\"\" 
{content}
\"\"\" 

ูุนุงููุฑ ุงูุชูููู ุงูุชู ูุฌุจ ุงูุงูุชุฒุงู ุจูุง ูู ุงูุชุญููู (ูุง ุชุนูุฏ ูุชุงุจุชูุง ูู ุงูุชูุฑูุฑุ ููุท ุงุณุชุฎุฏููุง ููุฑุฌุน ุฏุงุฎูู):

\"\"\" 
{FIXED_CRITERIA}
\"\"\" 
    """.strip()

    return prompt


def call_model(prompt: str) -> str:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": "You are an expert Arabic educational program and training package reviewer. Answer only in valid JSON and high-quality Arabic.",
            },
            {"role": "user", "content": prompt},
        ],
        temperature=0.1,
    )
    return response.choices[0].message.content.strip()

# ==============================
#          ููุทู ุงูุฒุฑ
# ==============================
if analyze_btn:
    if uploaded_file is None and not st.session_state["extracted_text"].strip():
        st.warning("ูู ูุถูู ุงุฑูุน ููู ุงูุญููุจุฉ ุฃูููุง.")
    else:
        # ูู ูุง ููุด ูุต ูุญููุธ ููู ูู ููู ูุฑููุน โ ุงุณุชุฎุฑุฌ ุงููุต
        if not st.session_state["extracted_text"].strip() and uploaded_file is not None:
            try:
                if uploaded_file.name.lower().endswith(".pdf"):
                    text = read_pdf(uploaded_file)
                else:
                    text = read_docx(uploaded_file)
                st.session_state["extracted_text"] = text
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ูุฑุงุกุฉ ุงูููู: {e}")

        content = st.session_state["extracted_text"].strip()
        if not content:
            st.error("ุชุนุฐูุฑ ุงุณุชุฎุฑุงุฌ ูุต ูู ุงูุญููุจุฉ. ุชุฃูุฏ ุฃู ุงูููู ูุญุชูู ุนูู ูุต ูููุณ ุตูุฑ ููุท.")
        else:
            with st.spinner("โณ ูุชู ุงูุขู ุชุญููู ุงูุญููุจุฉ ูุฅุนุฏุงุฏ ุชูุฑูุฑ ุชูุงุนูู..."):
                try:
                    prompt = build_prompt(content)
                    raw = call_model(prompt)

                    try:
                        data = json.loads(raw)
                    except json.JSONDecodeError:
                        # ูู ูุดู ุงูู JSON ูุนุฑุถ ุงููุต ููุง ูู
                        with report_container:
                            st.error("ุชุนุฐูุฑ ูุฑุงุกุฉ ุงูุชูุฑูุฑ ุจุตูุบุฉ ุชูุงุนููุฉ (JSON). ุณูุชู ุนุฑุถ ุงููุต ููุง ูู.")
                            st.write(raw)
                    else:
                        with report_container:
                            tab1, tab2, tab3 = st.tabs(
                                ["๐ ุงูููุฎูุต ุงูุชูููุฐู", "๐ ุงูุชูููู ุญุณุจ ุงููุฌุงูุงุช", "๐ฏ ุงูุฃููููุงุช ูุงูุชูุตูุงุช ุงูุนุงูุฉ"]
                            )

                            # ููุฎุต ุชูููุฐู
                            with tab1:
                                st.subheader("๐ ุงูููุฎูุต ุงูุชูููุฐู")
                                st.write(data.get("executive_summary", ""))
                                st.markdown("---")
                                st.subheader("ููุงุญุธุงุช ุนุงูุฉ")
                                st.write(data.get("overall_observations", ""))

                            # ุงููุฌุงูุงุช
                            with tab2:
                                st.subheader("๐ ุงูุชูููู ุงูุชูุตููู ุญุณุจ ุงููุฌุงูุงุช")
                                for domain in data.get("domains", []):
                                    name = domain.get("name", "ูุฌุงู")
                                    score = domain.get("score", 0)
                                    explanation = domain.get("score_explanation", "")
                                    strengths = domain.get("strengths", [])
                                    gaps = domain.get("gaps", [])
                                    recs = domain.get("recommendations", [])
                                    examples = domain.get("examples_of_issues", [])

                                    with st.expander(f"{name} โ ุงูุฏุฑุฌุฉ: {score} / 3", expanded=True):
                                        st.markdown(f"**ุชูุณูุฑ ุงูุฏุฑุฌุฉ:** {explanation}")

                                        col_a, col_b = st.columns(2)

                                        with col_a:
                                            st.markdown("**โ ููุงุท ุงูููุฉ:**")
                                            if strengths:
                                                for s in strengths:
                                                    st.markdown(f"- {s}")
                                            else:
                                                st.markdown("- ูุง ุชูุฌุฏ ููุงุท ููุฉ ูุงุถุญุฉ ุฃู ูู ูุชู ุฐูุฑูุง.")

                                            st.markdown("**โ๏ธ ุงููุฌูุงุช ูุงูุซุบุฑุงุช:**")
                                            if gaps:
                                                for g in gaps:
                                                    st.markdown(f"- {g}")
                                            else:
                                                st.markdown("- ูู ูุชู ุฑุตุฏ ูุฌูุงุช ุตุฑูุญุฉ ูู ูุฐุง ุงููุฌุงู ุฃู ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ.")

                                        with col_b:
                                            st.markdown("**๐ ุชูุตูุงุช ุงูุชุญุณูู:**")
                                            if recs:
                                                for r in recs:
                                                    st.markdown(f"- {r}")
                                            else:
                                                st.markdown("- ูุง ุชูุฌุฏ ุชูุตูุงุช ูุญุฏุฏุฉุ ุฑุจูุง ูุนุฏู ููุงูุฉ ุงููุนูููุงุช.")

                                            st.markdown("**๐ ุฃูุซูุฉ ุนูู ุงููุดููุงุช (ูุน ุงูุตูุญุงุช ุฅู ููุฌุฏุช):**")
                                            if examples:
                                                for ex in examples:
                                                    st.markdown(f"- {ex}")
                                            else:
                                                st.markdown("- ูู ุชูุฐูุฑ ุฃูุซูุฉ ูุญุฏุฏุฉุ ุฃู ูู ุชุชุถุญ ูุดููุงุช ูุงุถุญุฉ ูู ุงููุต.")

                            # ุงูุฃููููุงุช ูุงูุชูุตูุงุช ุงูุนุงูุฉ
                            with tab3:
                                st.subheader("๐ฏ ุฃูู ุฃููููุงุช ุงูุชุทููุฑ")
                                for p in data.get("top_priorities", []):
                                    st.markdown(f"- {p}")

                                st.markdown("---")
                                st.subheader("๐ ุชูุตูุงุช ุนุงูุฉ ุฅุถุงููุฉ")
                                for gr in data.get("global_recommendations", []):
                                    st.markdown(f"- {gr}")

                except Exception as e:
                    st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุฅุนุฏุงุฏ ุงูุชูุฑูุฑ: {e}")

st.markdown("</div>", unsafe_allow_html=True)
