import streamlit as st
from openai import OpenAI
from pypdf import PdfReader
import docx

# ---------- ูุนุงููุฑ ุงูุชูููู ุงูุซุงุจุชุฉ (ูุฎููุฉ ุนู ุงููุณุชุฎุฏู) ----------
FIXED_CRITERIA = """
ุงููุฌุงู ุงูุฃูู: ุงูุฃูุฏุงู
- ูุฌูุฏ ูุฏู ุนุงู ูุงุถุญ ูุนุจุฑ ุนูุง ูุณุนู ุงูุจุฑูุงูุฌ ุฅูู ุชุญูููู ููุฑุชุจุท ุจุงุญุชูุงุฌุงุช ุงููุชุฏุฑุจูู.
- ุชูุงูุฑ ููุงุชุฌ ุชุนูู ูุตุงุบุฉ ุจุดูู ุฌูุฏ (ูุงุถุญุฉุ ูุญุฏุฏุฉุ ุณููููุฉุ ูุงุจูุฉ ููููุงุณุ ูุงูุนูุฉ).
- ุชููุน ููุงุชุฌ ุงูุชุนูู ุจูู ุงูุฌูุงูุจ ุงููุนุฑููุฉ ูุงูููุงุฑูุฉ ูุงููุฌุฏุงููุฉ.
- ููุงุกูุฉ ููุงุชุฌ ุงูุชุนูู ููุฒูู ุงููุชุงุญ ูุชุชุงุจุนูุง ูู ุชุณูุณู ููุทูู.

ุงููุฌุงู ุงูุซุงูู: ุงููุญุชูู
- ุงุฑุชุจุงุท ููุถูุนุงุช ุงููุญุชูู ุจุงููุฏู ุงูุนุงู ูููุงุชุฌ ุงูุชุนูู.
- ููุงุกูุฉ ุงููุญุชูู ูุงุญุชูุงุฌุงุช ุงููุชุฏุฑุจูู ูุฎุจุฑุงุชูู ุงูุณุงุจูุฉ ูุจูุฆุฉ ุนูููู.
- ุฎูู ุงููุญุชูู ูู ุฃู ุชูููุฒ (ุฏููุ ุฌูุณุ ุฎูููุฉ ุงุฌุชูุงุนูุฉ...).
- ุชูุธูู ุงููุญุชูู: ุชุฏุฑุฌ ูู ุงูุณูู ุฅูู ุงูุตุนุจุ ููู ุงููุนููู ุฅูู ุงููุฌูููุ ูุนุฏู ุงูุชูุฑุงุฑุ ูุชุฌูุจ ุงูุญุดู.
- ุญุฏุงุซุฉ ุงููุญุชูู ูููุงูุจุชู ูููุณุชุฌุฏุงุช ุงูุนูููุฉ ูุงูุชูููููุฌูุฉ.

ุงููุฌุงู ุงูุซุงูุซ: ุงูุฃูุดุทุฉ ูุงูุฃุณุงููุจ ูุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ
- ุงุฑุชุจุงุท ุงูุฃูุดุทุฉ ุงูุชุฏุฑูุจูุฉ ุจุงูุฃูุฏุงู ูููุงุชุฌ ุงูุชุนูู ูู ุญูุซ ุงููู ูุงูููู ูุงูุชุณูุณู.
- ูุฑุงุนุงุฉ ุงูุฃูุดุทุฉ ููุณุชูู ุงููุชุฏุฑุจูู ูุงุญุชูุงุฌุงุชูู ูุงูุชูุงูุงุชูู ูุจูุฆุฉ ุนูููู.
- ูุฌูุฏ ุฃูุดุทุฉ ุงุณุชููุงููุฉ (ุชุนุงุฑูุ ุชููุนุงุชุ ููุงุนุฏุ ุชูุถูุญ ุฃูุฏุงู ุงูุจุฑูุงูุฌ ูุฏูุฑ ุงููุชุฏุฑุจ).
- ุชูุงูุฑ ุฎุตุงุฆุต ุงููุดุงุท ุงูุฌูุฏ (ุนููุงู ูุงุถุญุ ุฒูู ูุญุฏุฏุ ุฎุทูุงุช ููุธูุฉุ ููุงุฏ ูุฃุฏูุงุชุ ูุดุงุฑูุฉ ุฅูุฌุงุจูุฉุ ุฅุซุงุฑุฉ ุงูุชูููุฑุ ูุงุจููุฉ ุงูุชุทุจูู ูู ุงููุงูุน).
- ุชููุน ุฃุณุงููุจ ุงูุชุฏุฑูุจ (ูุญุงุถุฑุฉ ูุตูุฑุฉุ ููุงูุดุฉุ ุนุตู ุฐูููุ ุนูู ูุฑุฏูุ ุนูู ุชุนุงูููุ ูุนุจ ุฃุฏูุงุฑุ ูุญุงูุงุฉุ ุญู ูุดููุงุชุ ุงูุชุดุงู...).
- ุชููุน ุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ (ุนุฑูุถ ุชูุฏูููุฉุ ููุฏูููุงุชุ ููุญุงุชุ ููุงุฐุฌุ ุตูุฑุ ููุงุฏ ุฑูููุฉ...) ูููุงุกูุชูุง ููุฃูุฏุงู ูุงููุญุชูู ูุงููุชุฏุฑุจูู.

ุงููุฌุงู ุงูุฑุงุจุน: ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ
- ูุฌูุฏ ุฏููู ูุฏุฑุจ ูุชุถูู: ููุฏูุฉุ ููุฑุณุ ุฅุฑุดุงุฏุงุช ูููุฏุฑุจุ ุงูุฅุทุงุฑ ุงูุนุงู ููุจุฑูุงูุฌุ ุฃุฌูุฏุฉ ุนููุ ุฃูุดุทุฉ ุชุฏุฑูุจูุฉุ ููุงุญุธุงุชุ ูุฑุงุฌุน.
- ูุฌูุฏ ุฏููู ูุชุฏุฑุจ ูุชุถูู: ููุฏูุฉุ ููุฑุณุ ุงูุฅุทุงุฑ ุงูุนุงูุ ุฃุฌูุฏุฉ ุนููุ ุฃูุดุทุฉุ ูุณุงุญุงุช ููุชุฏููู.
- ูุฌูุฏ ูุงุฏุฉ ูุฑุฌุนูุฉ ุชุบุทู ููุถูุน ุงูุชุฏุฑูุจุ ููุณูุฉ ุฅูู ูุญุฏุงุช ูุงุถุญุฉ ุจุฃูุฏุงู ูุญุฏุฏุฉ.
- ูุฌูุฏ ุฃูุฑุงู ุนูู ูุนุฑูุถ ุชูุฏูููุฉ ูุฃุฏูุงุช ุชูููู ูุฑุชุจุทุฉ ุจุฃูุดุทุฉ ุงูุชุฏุฑูุจ.
- ูุถูุญ ุงููุบุฉ ูุจุณุงุทุชูุงุ ูุฎูููุง ูู ุงูุฃุฎุทุงุก ุงูุฅููุงุฆูุฉ ูุงููุญููุฉ ูุงููุทุจุนูุฉุ ูุงุณุชุฎุฏุงู ุนูุงูุงุช ุชุฑููู ููุงุณุจุฉ.
- ูุฌูุฏ ุชูุซูู ูููุญุชูู ููุงุฆูุฉ ูุฑุงุฌุน ููุตุงุฏุฑ ุฅุถุงููุฉ.
- ุฌูุฏุฉ ุงูุฅุฎุฑุงุฌ ูุงูุชุตููู (ุบูุงู ุฌุฐุงุจุ ููุฏูุฉุ ูุงุฆูุฉ ูุญุชููุงุชุ ุฃุฌูุฏุฉ ุนููุ ุชูุณูู ุงูุฎุทูุท ูุงููุณุงูุงุชุ ุงุณุชุฎุฏุงู ุฃุดูุงู ูุฑุณูู ุชูุถูุญูุฉุ ุชููุฑ ูุณุฎ ูุฑููุฉ ูุฅููุชุฑูููุฉุ ูุงุฆูุฉ ูุตุทูุญุงุช ููููุงููู ุงูุฑุฆูุณุฉ).

ุงููุฌุงู ุงูุฎุงูุณ: ุงูุชูููู
- ูุฌูุฏ ุชูููู ูุจูู ูููุงุณ ูุณุชูู ุงููุชุฏุฑุจูู ูุจู ุจุฏุงูุฉ ุงูุชุฏุฑูุจ.
- ูุฌูุฏ ุชูููู ุจูุงุฆู ุฃุซูุงุก ุงูุชูููุฐ ูููุงุณ ุงูุชูุฏู ูุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงููุณุชูุฑุฉ.
- ูุฌูุฏ ุชูููู ููุงุฆู ูููุงุณ ุชุญููู ููุงุชุฌ ุงูุชุนูู ูู ููุงูุฉ ุงูุจุฑูุงูุฌ.
- ุชููุน ุฃุฏูุงุช ุงูุชูููู (ุงุฎุชุจุงุฑุงุช ูุนุฑููุฉุ ุจุทุงูุงุช ููุงุญุธุฉ ููุงุฑูุฉุ ุงุณุชุจูุงูุงุช ูุฌุฏุงููุฉุ ุชูููู ููุชุฌุงุช ุงููุชุฏุฑุจูู ูุซู: ุฏุฑุณุ ูุณููุฉุ ุฎุทุฉุ ุชูุฑูุฑ...).
- ุงูุฅุดุงุฑุฉ ุฅูู ุฃุณุงููุจ ููุงุณุจุฉ ูุญุณุงุจ ูุงุนููุฉ ุงูุจุฑูุงูุฌ ุงูุชุฏุฑูุจู (ูุซู ูุณุจุฉ ุงููุณุจ ุงููุนุฏููุฉุ ูุฑุจุน ุฅูุชุง) ูุน ุฅููุงููุฉ ุชูุฏูู ุฃูุซูุฉ ูุจุณุทุฉ ููุงุณุชุฎุฏุงู.
"""

# ---------- ุฅุนุฏุงุฏ ุงูุตูุญุฉ ุงูุนุงูุฉ ----------
st.set_page_config(
    page_title="ูุณุงุนุฏ ุนููููู ููุฑุงุฌุนุฉ ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ",
    page_icon="๐",
    layout="wide",
    initial_sidebar_state="expanded",
)

# ---------- ุชูุณููุงุช CSS ูุฎุตุตุฉ ----------
CUSTOM_CSS = """
<style>
/* ุฎูููุฉ ุงููุญุชูู ุงูุฑุฆูุณู */
.main .block-container {
    padding-top: 1.5rem;
    padding-bottom: 2.5rem;
    padding-left: 2.5rem;
    padding-right: 2.5rem;
    background: #f3f4f6;
    border-radius: 24px;
}

/* ุชุฑููุณุฉ */
.header-card {
    background: linear-gradient(135deg, #1e3a8a, #2563eb);
    color: #f9fafb;
    padding: 1.5rem 1.8rem;
    border-radius: 18px;
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.35);
    margin-bottom: 1.5rem;
}
.header-title {
    font-size: 1.6rem;
    font-weight: 800;
    margin-bottom: 0.3rem;
}
.header-subtitle {
    font-size: 0.95rem;
    opacity: 0.95;
}

/* ูุฑูุช */
.card {
    background: #ffffff;
    border-radius: 18px;
    padding: 1.1rem 1.2rem;
    box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    margin-bottom: 1rem;
    border: 1px solid rgba(148, 163, 184, 0.25);
}
.card h3 {
    font-size: 1.05rem;
    margin-bottom: 0.4rem;
}

/* ุนูุงููู ูุฑุนูุฉ ุตุบูุฑุฉ */
.section-label {
    font-size: 0.8rem;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    color: #6b7280;
    margin-bottom: 0.1rem;
}

/* ูุต ูุณุงุนุฏุฉ */
.help-text {
    font-size: 0.78rem;
    color: #6b7280;
}

/* ุฃุฒุฑุงุฑ ุนุงูุฉ */
.stButton > button {
    border-radius: 12px !important;
    padding: 0.6rem 1.3rem !important;
    font-size: 0.95rem !important;
    font-weight: 600 !important;
    border: none !important;
    cursor: pointer !important;
    transition: 0.2s ease-in-out !important;
}

/* ุฒุฑ ุฑุฆูุณู */
.primary-btn button {
    background-color: #2563eb !important;
    color: #ffffff !important;
    box-shadow: 0 6px 15px rgba(37, 99, 235, 0.35) !important;
}
.primary-btn button:hover {
    background-color: #1e40af !important;
    transform: translateY(-2px) !important;
}

/* ุฒุฑ ุซุงููู */
.secondary-btn button {
    background-color: #e5e7eb !important;
    color: #111827 !important;
}
.secondary-btn button:hover {
    background-color: #d1d5db !important;
    transform: translateY(-2px) !important;
}

/* ุญููู ุงููุต */
textarea, .stTextArea textarea {
    border-radius: 12px !important;
}

/* ุณุงูุฏุจุงุฑ */
[data-testid="stSidebar"] {
    background: #0f172a !important;
}
.sidebar-title {
    font-size: 1.1rem;
    font-weight: 800;
    color: #e5e7eb;
    margin-bottom: 0.3rem;
}
.sidebar-subtitle {
    font-size: 0.85rem;
    color: #9ca3af;
    margin-bottom: 0.9rem;
}
.sidebar-badge {
    display: inline-block;
    padding: 0.18rem 0.55rem;
    border-radius: 999px;
    background: rgba(59, 130, 246, 0.15);
    color: #bfdbfe;
    font-size: 0.7rem;
    margin-bottom: 0.3rem;
}
.sidebar-footer {
    font-size: 0.75rem;
    color: #6b7280;
    margin-top: 1rem;
}
</style>
"""
st.markdown(CUSTOM_CSS, unsafe_allow_html=True)

# ---------- ุณุงูุฏุจุงุฑ: ูููุฉ ุงููุคุณุณุฉ ----------
with st.sidebar:
    st.markdown('<div class="sidebar-badge">ููุตุฉ ุฏุงุฎููุฉ</div>', unsafe_allow_html=True)
    st.markdown('<div class="sidebar-title">ูุคุณุณุฉ ุนููููู ููุชุนููู ูุงูุชุฏุฑูุจ</div>', unsafe_allow_html=True)
    st.markdown(
        '<div class="sidebar-subtitle">ูุณุงุนุฏ ุฐูู ูุชูููู ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ ููู ูุนุงููุฑ ุฌูุฏุฉ ุชุฑุจููุฉ ูุนุชูุฏุฉ.</div>',
        unsafe_allow_html=True,
    )
    st.markdown("---")
    st.markdown("**ุงุณุชุฎุฏุงูุงุช ุงูุฃุฏุงุฉ:**")
    st.write(
        "- ูุฑุงุฌุนุฉ ุญูุงุฆุจ ุฌุฏูุฏุฉ ูุจู ุงูุงุนุชูุงุฏ.\n"
        "- ุชุญููู ุญูุงุฆุจ ูุงุฆูุฉ ูุชุญุฏูุฏ ุฃููููุงุช ุงูุชุทููุฑ.\n"
        "- ุฏุนู ูุฑู ุงูุชุตููู ูุงูุชุทููุฑ ุงูุชุฑุจูู."
    )
    st.markdown("---")
    st.markdown(
        '<div class="sidebar-footer">ุงูุฅุตุฏุงุฑ 1.0 โ ูููุฐุฌ ุชุฌุฑูุจู ููุงุณุชุฎุฏุงู ุงูุฏุงุฎูู ุฏุงุฎู ูุฑู ุนููููู.</div>',
        unsafe_allow_html=True,
    )

# ---------- ุชุฑููุณุฉ ุฑุฆูุณูุฉ ----------
st.markdown(
    """
    <div class="header-card">
        <div class="header-title">๐ ูุณุงุนุฏ ุนููููู ููุฑุงุฌุนุฉ ูุชูููู ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉ</div>
        <div class="header-subtitle">
            ุงุฑูุน ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉุ ูุฏุน ุงููุณุงุนุฏ ุงูุฐูู ูููู ุจุชุญููููุง ูุชูููุฏ ุชูุฑูุฑ ูููู
            ูุณููุท ุงูุถูุก ุนูู ููุงุท ุงูููุฉ ููุฑุต ุงูุชุญุณูู ููู ูุนุงููุฑ ุฌูุฏุฉ ุซุงุจุชุฉ.
        </div>
    </div>
    """,
    unsafe_allow_html=True,
)

# ---------- ุฏูุงู ูุฑุงุกุฉ ุงููููุงุช ----------
def read_pdf(uploaded_file) -> str:
    reader = PdfReader(uploaded_file)
    text = ""
    for i, page in enumerate(reader.pages, start=1):
        try:
            page_text = page.extract_text() or ""
        except Exception:
            page_text = ""
        text += f"\n\n----- ุตูุญุฉ {i} -----\n\n{page_text}"
    return text.strip()


def read_docx(uploaded_file) -> str:
    document = docx.Document(uploaded_file)
    paragraphs = [p.text for p in document.paragraphs if p.text.strip()]
    return "\n".join(paragraphs).strip()

# ุญุงูุฉ ุงููุต ุงููุณุชุฎุฑุฌ
if "extracted_text" not in st.session_state:
    st.session_state["extracted_text"] = ""

# ---------- ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ ----------
col_left, col_right = st.columns([1.2, 0.9])

with col_left:
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<div class="section-label">Program Info</div>', unsafe_allow_html=True)
    st.markdown("### ๐งพ ุจูุงูุงุช ุงูุจุฑูุงูุฌ ูุฑูุน ุงูุญููุจุฉ")

    program_name = st.text_input("ุงุณู ุงูุจุฑูุงูุฌ ุงูุชุฏุฑูุจู", "ุจูุตูุฉ ุงูููุฌููู โ ุนููููู")
    target_audience = st.text_input("ุงููุฆุฉ ุงููุณุชูุฏูุฉ", "ููุฌููู ุงูููุงุฏ โ ูุนูููู โ ููุงุฏุงุช ุชุฑุจููุฉ")
    duration = st.text_input("ูุฏุฉ ุงูุจุฑูุงูุฌ", "ูููุงู โ ูกูข ุณุงุนุฉ ุชุฏุฑูุจูุฉ")
    main_theme = st.text_input("ุงููุฌุงู / ุงูููุถูุน ุงูุฑุฆูุณ", "ุงูุฅุดุฑุงู ุงูุชุฑุจูู ุงูุญุฏูุซ โ ุงูุชุบุฐูุฉ ุงูุฑุงุฌุนุฉ ุงูุจููุงุกุฉ")

    short_desc = st.text_area(
        "ูุตู ูุฎุชุตุฑ ููุจุฑูุงูุฌ (ุงุฎุชูุงุฑู)",
        "ุจุฑูุงูุฌ ููุฏู ุฅูู ุชุทููุฑ ููุงุฑุงุช ุงูููุฌูููู ุงูุชุฑุจูููู ูู ุงูุฅุดุฑุงู ุงูุญุฏูุซ ูุชุญุณูู ุชุนูู ุงูุทูุงุจ.",
        height=80,
    )

    st.markdown("#### ๐ ุฑูุน ููู ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ")
    uploaded_file = st.file_uploader(
        "ุงุฎุชุฑ ููู ุงูุญููุจุฉ (PDF ุฃู DOCX)",
        type=["pdf", "docx"],
        help="ููุถูู ุงุณุชุฎุฏุงู ูููุงุช PDF ูุตูุฉ ุฃู DOCX. ูู PDF ุนุจุงุฑุฉ ุนู ุตูุฑ ููุทุ ุณุชุญุชุงุฌ ูุชุญูููู ุฅูู ูุต ุจุงุณุชุฎุฏุงู ุฃุฏุงุฉ OCR.",
    )

    col_btn1, _ = st.columns([0.5, 0.5])
    with col_btn1:
        btn_convert = st.button("๐ฅ ุชุญููู ุงูููู ุฅูู ูุต / ุชุญุฏูุซ ุงููุต")

    if btn_convert:
        if uploaded_file is None:
            st.warning("ูู ูุถูู ุงุฎุชุฑ ููู ุฃูููุง ูุจู ุงูุชุญููู.")
        else:
            try:
                if uploaded_file.name.lower().endswith(".pdf"):
                    text = read_pdf(uploaded_file)
                else:
                    text = read_docx(uploaded_file)

                if not text:
                    st.warning("ูู ูุชู ุงุณุชุฎุฑุงุฌ ุฃู ูุต ูู ุงูููู. ุชุฃูุฏ ุฃู ุงูููู ูุญุชูู ุนูู ูุต ูููุณ ุตูุฑ ููุท.")
                else:
                    st.session_state["extracted_text"] = text
                    st.success(f"ุชู ุงุณุชุฎุฑุงุฌ ุงููุต ูู ุงูููู ุจูุฌุงุญ. ุนุฏุฏ ุงูุญุฑูู: {len(text):,}")
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุชุญููู ุงูููู ุฅูู ูุต: {e}")

    extracted_text = st.text_area(
        "ุงููุต ุงููุณุชุฎุฑุฌ ูู ุงูุญููุจุฉ (ููููู ุงูุชุนุฏูู ุนููู ุจุนุฏ ุงูุชุญููู)",
        key="extracted_text",
        height=220,
        help="ููููู ูุฑุงุฌุนุฉ ุงููุต ุฃู ุชุนุฏูู ุจุนุถ ุงูุฃุฌุฒุงุก ูุจู ุชูููุฏ ุงูุชูุฑูุฑ.",
    )

    st.markdown(
        '<div class="help-text">*ูููุง ูุงู ูุต ุงูุญููุจุฉ ุฃูุถุญ ูุฃูุซุฑ ุชูุธูููุงุ ูุงูุช ุฏูุฉ ุชูุฑูุฑ ุงููุฑุงุฌุนุฉ ุฃูุถู.</div>',
        unsafe_allow_html=True,
    )
    st.markdown("</div>", unsafe_allow_html=True)

with col_right:
    st.markdown('<div class="card">', unsafe_allow_html=True)
    st.markdown('<div class="section-label">Quality Framework</div>', unsafe_allow_html=True)
    st.markdown("### ๐ ูููุฌูุฉ ุงูุชูููู ุงููุนุชูุฏุฉ")

    st.info(
        "ูุชู ุชูููู ุงูุญููุจุฉ ููู ุฅุทุงุฑ ุฌูุฏุฉ ุชุฑุจูู ุซุงุจุช ุฏุงุฎู ุงููุธุงู ูุดูู:\n\n"
        "โข ุงููุฌุงู ุงูุฃูู: ุงูุฃูุฏุงู.\n"
        "โข ุงููุฌุงู ุงูุซุงูู: ุงููุญุชูู.\n"
        "โข ุงููุฌุงู ุงูุซุงูุซ: ุงูุฃูุดุทุฉ ูุงูุฃุณุงููุจ ูุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ.\n"
        "โข ุงููุฌุงู ุงูุฑุงุจุน: ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ.\n"
        "โข ุงููุฌุงู ุงูุฎุงูุณ: ุงูุชูููู.\n\n"
        "ุงููุนุงููุฑ ุงูุชูุตูููุฉ ูุถุจูุทุฉ ุฏุงุฎู ูุณุงุนุฏ ุนููููู ููุง ูููู ุชุนุฏูููุง ูู ูุฐู ุงููุงุฌูุฉ ูุถูุงู ุซุจุงุช ูููุฌ ุงูุชูููู."
    )

    st.markdown("#### ๐ฏ ูุฎุฑุฌุงุช ุงูุชูุฑูุฑ ุงููุชููุนุฉ")
    st.write(
        "- ููุฎุต ุชูููุฐู ุนู ุฌูุฏุฉ ุงูุญููุจุฉ.\n"
        "- ููุงุท ุงูููุฉ ุงูุฑุฆูุณุฉ.\n"
        "- ุงููุฌูุงุช ูุงูุซุบุฑุงุช.\n"
        "- ุชูุตูุงุช ุนูููุฉ ูุชุญุณูู ุงูุฃูุฏุงู ูุงููุญุชูู ูุงูุฃูุดุทุฉ ูุงูุชูููู.\n"
        "- ูุงุฆูุฉ ุจุฃูู ุฃููููุงุช ุงูุชุทููุฑ ุงูููุชุฑุญุฉ."
    )
    st.markdown("</div>", unsafe_allow_html=True)

# ---------- ุฏุงูุฉ ุจูุงุก ุงูุจุฑููุจุช ----------
def build_prompt(
    program_name: str,
    target_audience: str,
    duration: str,
    main_theme: str,
    short_desc: str,
    content: str,
) -> str:
    intro_desc = f"ูุตู ูุฎุชุตุฑ ุนู ุงูุจุฑูุงูุฌ:\n{short_desc}\n\n" if short_desc.strip() else ""

    prompt = f"""
ุฃูุช ุฎุจูุฑ ุนุฑุจู ูู ุชุตููู ููุฑุงุฌุนุฉ ุงูุญูุงุฆุจ ุงูุชุฏุฑูุจูุฉุ ูุชุนูู ุงูุขู ููุฑุงุฌุน ุฌูุฏุฉ ูุญููุจุฉ ุชุฏุฑูุจูุฉ ุชุงุจุนุฉ ููุคุณุณุฉ "ุนููููู".

ุงููุทููุจ ููู ุฃู ุชูููู ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ ุจุฏูุฉ ููู ุงููุฌุงูุงุช ูุงููุนุงููุฑ ุงูุชูุตูููุฉ ุงููุฑููุฉ ุฃุฏูุงูุ ุซู ุชุฎุฑุฌ ุจุชูุฑูุฑ ุดุงูู ูุชุถูู:
- ููุงุท ุงูููุฉ ูู ุงูุญููุจุฉ.
- ุงููุฌูุงุช ูุงูุซุบุฑุงุช.
- ููุชุฑุญุงุช ุนูููุฉ ูุชุญุณูู ุงูุฃูุฏุงูุ ุงููุญุชููุ ุงูุฃูุดุทุฉุ ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉุ ูุงูุชูููู.

ุฃูููุง: ูุนูููุงุช ุนู ุงูุจุฑูุงูุฌ ุงูุชุฏุฑูุจู (ููููู ุงูุณูุงูู):
- ุงุณู ุงูุจุฑูุงูุฌ: {program_name}
- ุงููุฆุฉ ุงููุณุชูุฏูุฉ: {target_audience}
- ูุฏุฉ ุงูุจุฑูุงูุฌ: {duration}
- ุงููุฌุงู / ุงูููุถูุน ุงูุฑุฆูุณ: {main_theme}

{intro_desc}ุซุงูููุง: ูุต ุงูุญููุจุฉ ุงูุชุฏุฑูุจูุฉ (ุงูุฃูุฏุงูุ ุงููุญุชููุ ุงูุฃูุดุทุฉุ ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉุ ุฃุฏูุงุช ุงูุชูููู...). ุฑููุฒ ูู ุชููููู ุนูู ูุฏู ุชูุงูุฑ ุงููุนุงููุฑ ุงูุชุงููุฉ ูููุณ ุนูู ุฅุนุงุฏุฉ ูุชุงุจุฉ ุงููุต:

\"\"\" 
{content}
\"\"\" 

ุซุงูุซูุง: ูุนุงููุฑ ุงูุชูููู ุงูุชู ูุฌุจ ุงูุงูุชุฒุงู ุจูุง (ุงููุฌุงูุงุชุ ุงููุนุงููุฑุ ุงููุคุดุฑุงุช):

\"\"\" 
{FIXED_CRITERIA}
\"\"\" 

ุฑุงุจุนูุง: ุทุฑููุฉ ุนููู ุงููุทููุจุฉ:

1) ูุฏูู ุฃูููุง ููุฎุตูุง ุชูููุฐููุง ูู ููุฑุชูู ุฅูู ุซูุงุซ ููุฑุงุช ููุถุญ:
   - ูุธุฑุฉ ุนุงูุฉ ุนูู ุฌูุฏุฉ ุงูุญููุจุฉ.
   - ุฃูู ููุงุท ุงูููุฉ.
   - ุฃูู ุงููุฌูุงุช.

2) ุจุนุฏ ุฐููุ ูููู ุงูุญููุจุฉ ููู ุงููุฌุงูุงุช ุงูุฎูุณุฉ (ุงูุฃูุฏุงู โ ุงููุญุชูู โ ุงูุฃูุดุทุฉ ูุงูุฃุณุงููุจ ูุงููุณุงุฆู ุงูุชุฏุฑูุจูุฉ โ ุงููุงุฏุฉ ุงูุชุฏุฑูุจูุฉ โ ุงูุชูููู)ุ ููุง ูู ูุฐููุฑุฉ ูู ุงููุนุงููุฑุ ูุน ุชูุธูู ุงูุชูุฑูุฑ ูุงูุชุงูู ูู ูู ูุนูุงุฑ:
   - ุฏุฑุฌุฉ ูู 0 ุฅูู 3 (0 = ุบูุฑ ูุชุญููุ 1 = ุถุนููุ 2 = ูุชูุณุทุ 3 = ูุชุญูู ุจุฏุฑุฌุฉ ุนุงููุฉ).
   - ุชูุณูุฑ ุณุจุจ ุงูุฏุฑุฌุฉ ูู 2โ4 ุฃุณุทุฑ ูุน ุงูุฅุดุงุฑุฉ ููุต ูู ุงูุญููุจุฉ ุฅู ุฃููู.
   - ุงูุชุฑุงุญ ุชุนุฏูู ุฃู ุฅุถุงูุฉ ุนูููุฉ ูุงุถุญุฉ ูุชุญุณูู ูุฐุง ุงููุนูุงุฑ.

3) ูู ููุงูุฉ ุงูุชูุฑูุฑุ ูุฏูู:
   - ูุงุฆูุฉ ูุฑุชูุจุฉ ุจุฃูู 5 ุฃููููุงุช ูุชุญุณูู ุงูุญููุจุฉ (ูู ุงูุฃูู ุฅูู ุงูุฃูู ุฃูููุฉ).
   - ุฃูุซูุฉ ุนูููุฉ ูุฃูุดุทุฉ ุฃู ุฃุณุงููุจ ุชุฏุฑูุจูุฉ ุฃู ุฃุฏูุงุช ุชูููู ูููู ุฅุถุงูุชูุง ุฃู ุชุนุฏูููุง ูุชูููุฉ ุงูุญููุจุฉ.

ุงูุชุจ ุชูุฑูุฑู ููู ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญู ุงูุจุณูุทุฉุ ูุจุฃุณููุจ ุจููุงุก ูุฑููุฒ ุนูู ุงูุญููู ูุงูุชุญุณููุงุช.
    """.strip()

    return prompt

# ---------- ุงุณุชุฏุนุงุก ูููุฐุฌ OpenAI ----------
def call_openai(prompt: str) -> str:
    client = OpenAI(api_key=st.secrets["OPENAI_API_KEY"])
    response = client.chat.completions.create(
        model="gpt-4o-mini",
        messages=[
            {
                "role": "system",
                "content": "You are an expert Arabic educational program and training package reviewer. Answer only in high-quality Arabic.",
            },
            {"role": "user", "content": prompt},
        ],
    )
    return response.choices[0].message.content.strip()

# ---------- ุงูุฃุฒุฑุงุฑ ูุงููุฎุฑุฌุงุช ----------
st.markdown("---")
st.markdown('<div class="section-label">Report</div>', unsafe_allow_html=True)
st.markdown("### ๐ง ุชูููุฏ ุงูุจุฑููุจุช / ุชูุฑูุฑ ุงูุชูููู")

col_a, col_b, col_c = st.columns([0.32, 0.32, 0.36])

with col_a:
    st.markdown('<div class="primary-btn">', unsafe_allow_html=True)
    generate_report_btn = st.button("๐ค ุชูููุฏ ุชูุฑูุฑ ุงูุชูููู ุนุจุฑ OpenAI")
    st.markdown('</div>', unsafe_allow_html=True)

with col_b:
    st.markdown('<div class="secondary-btn">', unsafe_allow_html=True)
    generate_prompt_btn = st.button("๐ ุชูููุฏ ุงูุจุฑููุจุช ููุท (ููุงุณุชุฎุฏุงู ุงููุฏูู)")
    st.markdown('</div>', unsafe_allow_html=True)

with col_c:
    st.markdown(
        '<div class="help-text">ููููู ูุณุฎ ุงูุชูุฑูุฑ ุงููุงุชุฌ ุฃู ุงูุจุฑููุจุช ูุงุณุชุฎุฏุงูู ูู ููุตุงุช ุฃุฎุฑู ุฃู ุญูุธู ูู ููู.</div>',
        unsafe_allow_html=True,
    )

output = st.empty()

if generate_prompt_btn:
    if not extracted_text.strip():
        st.warning("ูู ูุถูู ุงุฑูุน ุงูุญููุจุฉ ุฃู ุฃุฏุฎู ุงููุต ุงููุณุชุฎุฑุฌ ุฃูููุง.")
    else:
        prompt = build_prompt(
            program_name,
            target_audience,
            duration,
            main_theme,
            short_desc,
            extracted_text,
        )
        output.markdown("#### ๐ ุงูุจุฑููุจุช ุงููููููุฏ (ููุงุณุชุฎุฏุงู ุงููุชูุฏู)")
        st.code(prompt, language="markdown")

if generate_report_btn:
    if not extracted_text.strip():
        st.warning("ูู ูุถูู ุงุฑูุน ุงูุญููุจุฉ ุฃู ุฃุฏุฎู ุงููุต ุงููุณุชุฎุฑุฌ ุฃูููุง.")
    else:
        prompt = build_prompt(
            program_name,
            target_audience,
            duration,
            main_theme,
            short_desc,
            extracted_text,
        )
        with st.spinner("ุฌุงุฑู ุชูููุฏ ุชูุฑูุฑ ุงูุชูููู ูู ูููุฐุฌ OpenAI..."):
            try:
                report = call_openai(prompt)
                output.markdown("#### ๐ ุชูุฑูุฑ ุงูุชูููู ุงููุงุชุฌ")
                st.write(report)
            except Exception as e:
                st.error(f"ุญุฏุซ ุฎุทุฃ ุฃุซูุงุก ุงูุงุชุตุงู ุจู OpenAI: {e}")
